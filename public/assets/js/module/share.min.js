$(function(){app.theme="bright"==$.getParam("theme")?"bright":"dark",$("body").addClass("theme-"+app.theme)}),$(function(){"share/query"==$("body").data("location")&&{list:[],fields:[],page:1,pageSize:50,nextPage:!0,total:0,scopeField:"",displayFieldsPicker:null,templateOfHead:"listHead",templateOfBody:"listBody",initialized:!1,$table:$("table"),$displayFieldsPicker:$('[handle="pickDisplayFields"]'),$pageLoading:$(".page-loading"),$total:$(".query-total"),init:function(){return this.initialized?this:(this._getPageDataThenRender(),this._listen(),this.initialized=!0,this)},_listen:function(){var e=this;return $(window).scroll(_.debounce(function(){$(this).scrollTop()+$(this).height()-e.$pageLoading.offset().top>0&&e._getPageDataThenRender()},300)),this.$displayFieldsPicker.bind("displayFieldsPicker.change",function(){e.fields=e.displayFieldsPicker.getChecked(),e._renderHead(),e._renderBody()}),this.$table.on("click",'[handle="showSource"]',function(){var t=$(this).closest("tr").addClass("source-top"),i=t.data("index"),a=e.list[i],s="{\n";for(var r in a)0!=r.indexOf("_")&&(s+='    "<span style="color: #0ac">'+r+'</span>":"'+a[r]+'"\n');s+="}",t.after('<tr class="source"><td colspan="100"><pre>'+s+"</pre></td></tr>"),$(this).addClass("hide"),$(this).siblings('[handle="hideSource"]').removeClass("hide")}),this.$table.on("click",'[handle="hideSource"]',function(){$(this).closest("tr").removeClass("source-top").next(".source:first").remove(),$(this).addClass("hide"),$(this).siblings('[handle="showSource"]').removeClass("hide")}),this},_getPageDataThenRender:function(){if(!this.nextPage)return this;var e=this,t=this.page++,i="/share/search/"+app.uuid+"&page="+t+"&pageSize="+this.pageSize;return $.http.get(i,{},{progress:!0,success:function(i){e.scopeField=i.scope.field,i.list=e._formatAfterGetList(i.list),e.list=e.list.concat(i.list),1==t&&(e._renderFieldsPicker(i.list.length?_.keys(i.list[0]):[]),e.fields=e.displayFieldsPicker.getChecked(),e._renderHead()),e._appendBody(i.list,(t-1)*e.pageSize),e.nextPage=!!i.list.length,e.$total.text(i.total),e.nextPage||e.$pageLoading.text("数据已全部加载")},error:function(e,t,i){$.message.warn(i)}}),this},_renderHead:function(){var e=$.render(this.templateOfHead,{fields:this.fields});return $("thead",this.$table).empty().html(e),$('thead [data-toggle="tooltip"]',this.$table).tooltip(),this},_renderBody:function(){var e=$.render(this.templateOfBody,{list:this.list,fields:this.fields,from:0});return $("tbody",this.$table).html(e),this},_appendBody:function(e,t){var i=$.render(this.templateOfBody,{list:e,fields:this.fields,from:t});return $("tbody",this.$table).append(i),this},_renderFieldsPicker:function(e){return this.$displayFieldsPicker.displayFieldsPicker({fields:e.sort(),localStorageKey:app.uuid}),this.displayFieldsPicker=this.$displayFieldsPicker.data("instance.displayFieldsPicker"),this},_formatAfterGetList:function(e){for(var t=0;t<e.length;t++){var i=e[t];i[this.scopeField]&&(i[this.scopeField]=moment(i[this.scopeField]).format("YYYY-MM-DD HH:mm:ss"))}return e}}.init()}),$(function(){"share/chart"==$("body").data("location")&&{$el:$(".chart-item"),initialized:!1,init:function(){return this.initialized?this:(this._render()._listen(),this.initialized=!0,this)},_render:function(){var e=this;return this.$el.css("height",$(window).height()-1),this.$el.find(".chart-body").esChart({theme:app.theme,url:"/share/search/"+app.uuid,format:app.chart.format,loadingStart:function(){e.$el.find('[handle="refresh"] .icon-refresh').addClass("hide"),e.$el.find('[handle="refresh"] .icon-loading').removeClass("hide")},loadingDone:function(){e.$el.find('[handle="refresh"] .icon-refresh').removeClass("hide"),e.$el.find('[handle="refresh"] .icon-loading').addClass("hide")},$scopeRange:$(".chart-datetime .datetime-range",e.$el)}),this},_listen:function(){var e=this;return this.$el.on("click",'[handle="refresh"]',function(){$(this).children(".icon-refresh").hasClass("hide")||e.$el.find(".chart-body").data("instance.esChart").refresh()}),$(window).resize(_.debounce(function(){e.$el.css("height",$(window).height()-1),e.$el.find(".chart-body").data("instance.esChart").resize()},300)).trigger("resize"),this}}.init()}),$(function(){"share/dashboard"==$("body").data("location")&&({$dashboard:$("#dashboard"),templateOfItem:$("#template-chart-item").html(),templateOfEmpty:$("#template-chart-empty").html(),initialized:!1,init:function(){return this.initialized?this:(this._listen()._render(),this.initialized=!0,this)},_render:function(){var e=this;return this.$dashboard.dashboardGrid({content:e.templateOfItem,empty:e.templateOfEmpty}),this},_listen:function(){var e=this;return this.$dashboard.on("render.dashboardGrid",".dashboard-cell",function(){e._drawEsChart($(this).children())}),this.$dashboard.on("click",'[handle="refresh"]',function(){$(this).children(".icon-refresh").hasClass("hide")||$(this).closest(".chart-item").children(".chart-body").data("instance.esChart").refresh()}),this},_drawEsChart:function(e){var t=this._getChartModelById(e.data("id"));return e.find(".chart-title").text(t.name),e.find(".chart-body").esChart({theme:app.theme,url:this._getEsChartUrl(t),format:t.format,loadingStart:function(){e.find('[handle="refresh"] .icon-refresh').addClass("hide"),e.find('[handle="refresh"] .icon-loading').removeClass("hide")},loadingDone:function(){e.find('[handle="refresh"] .icon-refresh').removeClass("hide"),e.find('[handle="refresh"] .icon-loading').addClass("hide")},$scopeRange:$(".chart-datetime .datetime-range",e)}),this},_getChartModelById:function(e){return _.findWhere(app.charts,{id:e+""})},_getEsChartUrl:function(e){return"/share/search/"+app.uuid+"/?chartId="+e.id}}.init(),{$el:$("#auto-refresh"),intervalId:null,initialized:!1,init:function(){if(this.initialized)return this;this._listen();var e=this._fromLocalStorage()?this._fromLocalStorage():0;return $('.dropdown-menu li[value="'+e+'"]',this.$el).trigger("click"),this.initialized=!0,this},_listen:function(){var e=this;$(".dropdown-menu li",this.$el).click(function(){$(this).hasClass("active")||(e._pick($(this).attr("value")),$(this).addClass("active").siblings().removeClass("active"),$("button .text",e.$el).text($(this).find("a").text()))})},_pick:function(e){this.intervalId&&window.clearInterval(this.intervalId),this.intervalId=window.setInterval(function(){$('.chart-item [handle="refresh"]').trigger("click")},parseInt(e)?1e3*parseInt(e):1e11),this._toLocalStorage(e)},_toLocalStorage:function(e){return window.localStorage.setItem("auto-refresh",e),this},_fromLocalStorage:function(){return window.localStorage.getItem("auto-refresh")}}.init())});