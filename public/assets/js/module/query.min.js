$(function(){({default:{id:"",name:"",builder:"",indexId:"",groupId:""},validator:{},template:"query",initialized:!1,$modal:$("#modal-createQuery"),$builder:$(".chart-builder"),$preview:$(".chart-container .chart-preview"),$form:{},init:function(){return this.initialized?this:(this._render()._listen(),this.initialized=!0,this)},_render:function(){return app.query?$(".chart-container").removeClass("hide"):($('[handle="createQuery"]').tooltip("show"),$(".no-query-tips").removeClass("hide")),this},_renderForm:function(e){var i=$.render(this.template,e);return $(".modal-body",this.$modal).html(i),this.$form=$("#modal-createQuery form"),$('[name="indexId"]',this.$form).select({options:app.indices}),$('[name="groupId"]',this.$form).select({options:app.groups}),this._setValidator()},_listen:function(){var e=this;return $('[handle="createQuery"]').click(function(){e._create()}),$('[handle="deleteQuery"]').click(function(){e._delete(app.query)}),$('[handle="copyQuery"]').click(function(){e._copy(app.query)}),$('[handle="shareQuery"]').click(function(){e._share(app.query)}),$(window).resize(_.debounce(function(){e.$builder.height($(window).height()-87),e.$preview.height($(window).height()-56)},300)).trigger("resize"),$('[handle="submit"]',this.$modal).click(function(){e.$form.trigger("submit")}),this.$modal.on("submit","form",function(){return e._submit(),!1}),this},_create:function(){return $(".modal-title",this.$modal).text("创建查询"),this._renderForm(this.default),this.$modal.modal("show"),this},_delete:function(e){$.message.confirm("确认删除这个查询吗?",{content:e.name,yes:function(){$.http.get("/query/delete/"+e.id,{},{success:function(i){$.message.tip("删除成功",function(){window.location.href="/query/detail/"+e.groupId})},error:function(e,i,t){$.message.warn(t)}})}})},_copy:function(e){return $(".modal-title",this.$modal).text("复制查询"),this._renderForm(e),this.$modal.modal("show"),this},_share:function(e){return $.makeShareUrl("query",e.id),this},_setValidator:function(){return this.validator=this.$form.validator({rules:{name:"required|maxLength:50",indexId:"required",groupId:"required"}}).data("instance.validator"),this},_submit:function(){if(!this.validator.isValid())return!1;var e=this;$.http.post("/query/create",$.getValByNames(["name","indexId","groupId","builder"],this.$form),{success:function(i){e.$modal.modal("hide"),$.message.tip("保存成功",function(){window.location.reload()})},error:function(e,i,t){$.message.warn(t)}})}}).init()}),$(function(){app.getFieldsByTypes=function(e){var i=[];for(var t in this.mapping)$.inArray(this.mapping[t],e)>=0&&i.push(t);return i},app.getFieldsTop5=function(){var e=_.keys(this.mapping);return _.first(e,5)},{$panel:$(".chart-container .chart-panel"),$builder:$(".chart-container .chart-builder form"),$preview:$(".chart-container .chart-preview"),builder:{},_initialized:!1,init:function(){return this._initialized?this:(this._render()._listen()._run(),this._initialized=!0,this)},_render:function(){var e=this;return $('input[name="scopeField"]',this.$builder).dropdownSelector({options:app.getFieldsByTypes(["date"])}),$('input[name="scopeRange"]',this.$builder).datetimeRangePicker(),$('input[name="filters"]',this.$builder).esFilter({mapping:app.mapping}),$('input[name="fields"]',this.$builder).each(function(){var i=$(this).attr("name");$.inArray(i,e.table.fields)>=0&&$(this).prop("checked",!0)}),this},_listen:function(){var e=this;return $('[handle="runQuery"]').click(function(){e._save()._run()}),$('[handle="builderDrawer"]').click(function(){var i=$(this).children(".iconfont");i.hasClass("icon-drawer-left")?(i.removeClass("icon-drawer-left").addClass("icon-drawer-right"),e.$panel.css("width","14px"),e.$preview.css("margin-left","24px")):(i.removeClass("icon-drawer-right").addClass("icon-drawer-left"),e.$panel.css("width","400px"),e.$preview.css("margin-left","410px"))}),this},_getBuilder:function(){return{scope:{field:$('input[name="scopeField"]',this.$builder).val(),range:$('input[name="scopeRange"]',this.$builder).val()},filters:$('input[name="filters"]',this.$builder).esFilter().val()}},_validate:function(){var e=0;return $("input:text",this.$builder).each(function(){$(this).val()||($(this).tooltip("show"),e++)}),e&&$.ffanTips.show({content:"有"+e+"项为空, 请按提示填写",rank:"warning"}),!e},_save:function(){if(this._validate()){var e=this._getBuilder();return $.http.post("/query/save/"+app.query.id,{builder:JSON.stringify(e)},{success:function(){app.query.builder=e},error:function(e,i,t){$.message.warn(t)}}),this}},_run:function(){var e=app.query.index.name,i="/query/table?url="+app.query.cluster.url+"&index="+e+"&builder="+JSON.stringify(this._getBuilder());return this.$preview.children("iframe").length?this.$preview.children("iframe").attr("src",i):this.$preview.append('<iframe src="'+encodeURI(i)+'" width="100%" height="100%" frameborder="0"></iframe>'),this}}.init()});