$(function(){if("setting/es"==$("body").data("location")){var t=app.cluster;({default:{id:"",protocol:"http",host:"",port:"9200"},template:"cluster",templateForHistory:"clusterHistory",validator:{},initialized:!1,$modal:$("#modal-cluster"),$tab:$("#modal-cluster .unit-tab"),$submitBtn:$('#modal-cluster [handle="submit"]'),$form:[],init:function(){return this.initialized?this:(this._listen(),this.initialized=!0,this)},_listen:function(){var t=this;return $('[handle="createUrl"]').click(function(){t.$tab.hide(),t._create()}),$('[handle="configUrl"]').click(function(){t.$tab.show(),$('[handle="selectHistory"]',t.$tab).trigger("click")}),$(".tab-item",this.$tab).click(function(){switch($(this).addClass("active").siblings(".active").removeClass("active"),$(this).attr("handle")){case"update":t._update();break;case"create":t._create();break;case"selectHistory":t._selectHistory()}}),t.$submitBtn.click(function(){t.$form.trigger("submit")}),this},_create:function(){var t=$.extend(!0,{},this.default);this._render(t)},_update:function(){var e=t.url.split("://"),i={id:t.id,protocol:e[0],host:e[1].split(":")[0],port:e[1].split(":")[1]};this._render(i)},_selectHistory:function(){var t=this;$.http.get("/es/cluster",{},{success:function(e){t._renderHistory(e.list)}})},_render:function(t){var e=$.render(this.template,t);return this.$modal.find(".modal-body").html(e),this.$form=this.$modal.find("form"),this.$modal.modal("show").find('[handle="submit"]').show(),$('[name="protocol"]',this.$form).select({options:["http","https"]}),this._validate()._submit()},_renderHistory:function(t){var e=$.render(this.templateForHistory,{list:t});return this.$modal.find(".modal-body").html(e),this.$form=this.$modal.find("form"),this.$modal.modal("show").find('[handle="submit"]').hide(),this._submitSelectHistory()},_validate:function(){return this.$form.validator({rules:{host:"required",port:"required"}}),this.validator=this.$form.data("instance.validator"),this},_submit:function(){var t=this;return this.$form.submit(function(){return!!t.validator.isValid()&&(t.$submitBtn.loading("start"),$.http.post("/es/cluster",{id:$.getValByName("id",$(this)),url:$.getValByName("protocol",$(this))+"://"+$.getValByName("host",$(this))+":"+$.getValByName("port",$(this))},{success:function(){t.$modal.modal("hide"),$.message.tip("保存成功",function(){window.location.reload()})},error:function(t,e,i){$.message.warn(i)},complete:function(){t.$submitBtn.loading("done")}}),!1)}),this},_submitSelectHistory:function(){var t=this;return this.$form.find('[handle="switchCluster"]').click(function(){return!$(this).hasClass("active")&&($.http.get("/es/switch/"+$(this).data("id"),{},{success:function(){t.$modal.modal("hide"),$.message.tip("正在切换",function(){window.location.reload()})},error:function(t,e,i){$.message.warn(i)}}),!1)}),this}}).init();var e={model:{activeShards:0,primaryShards:0,indexNum:0,chartNum:0,queryNum:0},initialized:!1,init:function(){return this.initialized?this:(this.render(),this.initialized=!0,this)},render:function(){var t=this;$.http.get("/es/statistics",{},{success:function(e){var i={targets:t.model,activeShards:e.activeShards,primaryShards:e.primaryShards,indexNum:e.indexNum,chartNum:e.chartNum,queryNum:e.queryNum,round:1,easing:"linear",delay:300,duration:1500,update:function(){document.querySelector("#index-num").innerHTML=t.model.indexNum,document.querySelector("#chart-num").innerHTML=t.model.chartNum,document.querySelector("#query-num").innerHTML=t.model.queryNum,document.querySelector("#primary-shards").innerHTML=t.model.primaryShards,document.querySelector("#active-shards").innerHTML=t.model.activeShards}};anime(i)},error:function(t,e,i){$.message.alert(i)}})}};t.id&&e.init(),{default:{id:null,index:"",type:"",defaultDateField:"",mapping:"",comment:"",sort:100},template:"index",templateForList:"index-list",initialized:!1,$el:$("#table-index"),$modal:$("#modal-index"),$submitBtn:$('#modal-index [handle="submit"]'),$form:[],init:function(){return this.initialized?this:(this._listen()._getListThenRender(),this.initialized=!0,this)},_listen:function(){var e=this;return $('[handle="create"]',this.$el).click(function(){e._create()}),this.$el.on("click",'tbody [handle="update"]',function(){e._update($(this).closest("tr").data("model"))}),this.$el.on("click",'tbody [handle="delete"]',function(){e._delete($(this).closest("tr").data("model"))}),this.$modal.on("change",'[name="index"]',function(){$.http.get("/option/esTypes",{url:t.url,index:$(this).val()},{async:!1,success:function(t){t.length?e.validator.removeError("index"):e.validator.addError("index","索引不存在, 或者该索引下没有文档数据"),$('[name="type"]',e.$form).select("updateOptions",t)}})}),this.$modal.on("change",'[name="type"]',function(){$.http.get("/option/esMapping",{url:t.url,index:$.getValByName("index",e.$modal),type:$(this).val()},{async:!1,success:function(t){$('[name="mapping"]',e.$form).val(JSON.stringify(t));var i=[];for(var a in t)"date"==t[a]&&i.push(a);t.length&&!i.length?e.validator.addError("type","该类型下的文档数据没有日期字段"):e.validator.removeError("type"),$('[name="defaultDateField"]',e.$form).select("updateOptions",i)}})}),e.$submitBtn.click(function(){e.$form.trigger("submit")}),this},_getListThenRender:function(){var t=this;return $.http.get("/es/index",{},{success:function(e){var i=$.render(t.templateForList,e);t.$el.find("tbody").html(i)}}),this},_create:function(){var t=$.extend(!0,{},this.default);this._renderDetail(t)},_update:function(t){this._renderDetail(t)},_delete:function(t){var e=this;$.message.confirm("确认删除这个索引吗?",{content:t.name,yes:function(){$.http.delete("/es/index/"+t.id,{},{success:function(){e._getListThenRender()},error:function(t,e,i){$.message.warn(i)}})}})},_renderDetail:function(t){var e=$.render(this.template,t);return this.$modal.find(".modal-body").html(e),this.$form=this.$modal.find("form"),this.$modal.modal("show"),$('[name="type"]',this.$form).select(),$('[name="defaultDateField"]',this.$form).select(),$('[data-toggle="tooltip"]').tooltip(),this._validate()._submit()},_validate:function(){return this.$form.validator({rules:{index:"required",type:"required",defaultDateField:"required"}}),this.validator=this.$form.data("instance.validator"),this},_submit:function(){var t=this;return this.$form.submit(function(){return!!t.validator.isValid()&&($.http.post("/es/index",$.getValByNames(_.keys(t.default),t.$form),{success:function(e,i,a){t.$modal.modal("hide"),t._getListThenRender()},error:function(t,e,i){$.message.warn(i)}}),!1)}),this}}.init()}}),$(function(){"setting/dashboard"==$("body").data("location")&&{$modalOfGroup:$("#modal-group"),$templateOfGroup:"dashboard",$modalOfDashboard:$("#modal-dashboard"),$templateOfDashboard:"dashboard",initialized:!1,init:function(){return this.initialized?this:(this._listen(),this.initialized=!0,this)},_listen:function(){var t=this;$('[handle="showDashboards"]').click(function(){$(this).addClass("hide"),$(this).siblings('[handle="hideDashboards"]').removeClass("hide"),$(this).closest(".unit-table").children(".table-body").removeClass("hide")}),$('[handle="hideDashboards"]').click(function(){$(this).addClass("hide"),$(this).siblings('[handle="showDashboards"]').removeClass("hide"),$(this).closest(".unit-table").children(".table-body").addClass("hide")}),$('[handle="createGroup"]').click(function(){t.$modalOfGroup.find(".modal-title").text("创建分组"),t._saveGroup({id:"",name:"",sort:100})}),$('[handle="updateGroup"]').click(function(){t.$modalOfGroup.find(".modal-title").text("编辑分组"),t._saveGroup($(this).closest("li").data("model"))}),$('[handle="submit"]',this.$modalOfGroup).click(function(){$("form",t.$modalOfGroup).trigger("submit")}),this.$modalOfGroup.on("submit","form",function(){return t._submitGroup($(this)),!1}),$('[handle="deleteGroup"]').click(function(){t._deleteGroup($(this).closest("li").data("model"))}),$('[handle="updateDashboard"]').click(function(){t._updateDashboard($(this).closest("tr").data("model"))}),$('[handle="submit"]',this.$modalOfDashboard).click(function(){$("form",t.$modalOfDashboard).trigger("submit")}),this.$modalOfDashboard.on("submit","form",function(){return t._submitDashboard($(this)),!1}),$('[handle="deleteDashboard"]').click(function(){t._deleteDashboard($(this).closest("tr").data("model"))})},_saveGroup:function(t){var e=$.render("group",t);this.$modalOfGroup.find(".modal-body").html(e).find("form").validator({rules:{name:"required|maxLength:50",sort:"required"}}),this.$modalOfGroup.modal("show")},_submitGroup:function(t){if(!t.data("instance.validator").isValid())return!1;var e=this;$.http.post("/setting/saveDashboardGroup",$.getValByNames(["id","name","sort"],t),{success:function(t){e.$modalOfGroup.modal("hide"),$.message.tip("保存成功",function(){window.location.reload()})},error:function(t,e,i){$.message.warn(i)}})},_deleteGroup:function(t){$.message.confirm("确认删除这个分组吗?",{content:t.name,yes:function(){$.http.get("/setting/deleteDashboardGroup/"+t.id,{},{success:function(t){$.message.tip("删除成功",function(){window.location.reload()})},error:function(t,e,i){$.message.warn(i)}})}})},_updateDashboard:function(t){var e=$.render("dashboard",t),i=this.$modalOfDashboard.find(".modal-body").html(e).find("form");$('[name="groupId"]',i).select({options:app.groups}),$('[name="groupId"]',i).select("check",t.groupId),i.validator({rules:{name:"required|maxLength:50",sort:"required",groupId:"required"}}),this.$modalOfDashboard.modal("show")},_submitDashboard:function(t){if(!t.data("instance.validator").isValid())return!1;var e=this;$.http.post("/dashboard/save/",$.getValByNames(["id","name","sort","groupId"],t),{success:function(t){e.$modalOfDashboard.modal("hide"),$.message.tip("保存成功",function(){window.location.reload()})},error:function(t,e,i){$.message.warn(i)}})},_deleteDashboard:function(t){$.message.confirm("确认删除这个查询吗?",{content:t.name,yes:function(){$.http.get("/dashboard/delete/"+t.id,{},{success:function(t){$.message.tip("删除成功",function(){window.location.reload()})},error:function(t,e,i){$.message.warn(i)}})}})}}.init()}),$(function(){"setting/query"==$("body").data("location")&&{$modalOfGroup:$("#modal-group"),$templateOfGroup:"group",$modalOfQuery:$("#modal-query"),$templateOfQuery:"query",initialized:!1,init:function(){return this.initialized?this:(this._listen(),this.initialized=!0,this)},_listen:function(){var t=this;$('[handle="showQueries"]').click(function(){$(this).addClass("hide"),$(this).siblings('[handle="hideQueries"]').removeClass("hide"),$(this).closest(".unit-table").children(".table-body").removeClass("hide")}),$('[handle="hideQueries"]').click(function(){$(this).addClass("hide"),$(this).siblings('[handle="showQueries"]').removeClass("hide"),$(this).closest(".unit-table").children(".table-body").addClass("hide")}),$('[handle="createGroup"]').click(function(){t.$modalOfGroup.find(".modal-title").text("创建分组"),t._saveGroup({id:"",name:"",sort:100})}),$('[handle="updateGroup"]').click(function(){t.$modalOfGroup.find(".modal-title").text("编辑分组"),t._saveGroup($(this).closest("li").data("model"))}),$('[handle="submit"]',this.$modalOfGroup).click(function(){$("form",t.$modalOfGroup).trigger("submit")}),this.$modalOfGroup.on("submit","form",function(){return t._submitGroup($(this)),!1}),$('[handle="deleteGroup"]').click(function(){t._deleteGroup($(this).closest("li").data("model"))}),$('[handle="updateQuery"]').click(function(){t._updateQuery($(this).closest("tr").data("model"))}),$('[handle="submit"]',this.$modalOfQuery).click(function(){$("form",t.$modalOfQuery).trigger("submit")}),this.$modalOfQuery.on("submit","form",function(){return t._submitQuery($(this)),!1}),$('[handle="deleteQuery"]').click(function(){t._deleteQuery($(this).closest("tr").data("model"))})},_saveGroup:function(t){var e=$.render("group",t);this.$modalOfGroup.find(".modal-body").html(e).find("form").validator({rules:{name:"required|maxLength:50",sort:"required"}}),this.$modalOfGroup.modal("show")},_submitGroup:function(t){if(!t.data("instance.validator").isValid())return!1;var e=this;$.http.post("/setting/saveGroup",$.getValByNames(["id","name","sort"],t),{success:function(t){e.$modalOfGroup.modal("hide"),$.message.tip("保存成功",function(){window.location.reload()})},error:function(t,e,i){$.message.warn(i)}})},_deleteGroup:function(t){$.message.confirm("确认删除这个分组吗?",{content:t.name,yes:function(){$.http.get("/setting/deleteGroup/"+t.id,{},{success:function(t){$.message.tip("删除成功",function(){window.location.reload()})},error:function(t,e,i){$.message.warn(i)}})}})},_updateQuery:function(t){var e=$.render("query",t),i=this.$modalOfQuery.find(".modal-body").html(e).find("form");$('[name="groupId"]',i).select({options:app.groups}),$('[name="groupId"]',i).select("check",t.groupId),i.validator({rules:{name:"required|maxLength:50",sort:"required",groupId:"required"}}),this.$modalOfQuery.modal("show")},_submitQuery:function(t){if(!t.data("instance.validator").isValid())return!1;var e=this,i=$.getValByName("id",t);$.http.post("/query/save/"+i,$.getValByNames(["name","sort","groupId"],t),{success:function(t){e.$modalOfQuery.modal("hide"),$.message.tip("保存成功",function(){window.location.reload()})},error:function(t,e,i){$.message.warn(i)}})},_deleteQuery:function(t){$.message.confirm("确认删除这个查询吗?",{content:t.name,yes:function(){$.http.get("/query/delete/"+t.id,{},{success:function(t){$.message.tip("删除成功",function(){window.location.reload()})},error:function(t,e,i){$.message.warn(i)}})}})}}.init()}),$(function(){"setting/share"==$("body").data("location")&&($('[handle="show"]').click(function(){$(this).addClass("hide"),$(this).siblings('[handle="hide"]').removeClass("hide"),$(this).closest(".unit-table").children(".table-body").removeClass("hide")}),$('[handle="hide"]').click(function(){$(this).addClass("hide"),$(this).siblings('[handle="show"]').removeClass("hide"),$(this).closest(".unit-table").children(".table-body").addClass("hide")}),$('[name="status"]').switch().bind("switch-on",function(){var t=$(this).closest("tr").data("id"),e=$(this);$.http.post("/share/update/"+t,{status:"1"},{error:function(t,i,a){$.message.warn(a),e.switch("rollback")},async:!1})}).bind("switch-off",function(){var t=$(this).closest("tr").data("id"),e=$(this);$.http.post("/share/update/"+t,{status:"0"},{error:function(t,i,a){$.message.warn(a),e.switch("rollback")},async:!1})}),$('[handle="delete"]').click(function(){var t=$(this).closest("tr"),e=t.data("id");$.message.confirm("确认删除这个分享链接吗?",{yes:function(){$.http.get("/share/delete/"+e,{},{success:function(e){$.message.tip("删除成功",function(){t.remove()})},error:function(t,e,i){$.message.warn(i)}})}})}))}),$(function(){"setting/team"==$("body").data("location")&&($('[handle="create"]').click(function(){$("#modal-team").find('input[name="id"]').val(""),$("#modal-team").find('input[name="name"]').val(""),$("#modal-team").find(".modal-title").text("创建团队"),$("#modal-team").modal("show")}),$('[handle="update"]').click(function(){var t=$(this).closest("tr").data("model");$("#modal-team").find('input[name="id"]').val(t.id),$("#modal-team").find('input[name="name"]').val(t.name),$("#modal-team").find(".modal-title").text("编辑团队"),$("#modal-team").modal("show")}),$('[handle="delete"]').click(function(){var t=$(this).closest("tr").data("model");$.message.confirm('确认解散这个"团队"吗?',{content:t.name,yes:function(){$.http.post("/team/delete/"+t.id,{},{success:function(){$.message.tip("解散成功",function(){window.location.reload()})},error:function(t,e,i){$.message.warn(i)}})}})}),$('[handle="quit"]').click(function(){var t=$(this).closest("tr").data("model");$.message.confirm('确认退出这个"团队"吗?',{content:t.name,yes:function(){$.http.post("/team/quit/"+t.id,{},{success:function(){$.message.tip("操作成功",function(){window.location.reload()})},error:function(t,e,i){$.message.warn(i)}})}})}),$('#modal-team [handle="submit"]').click(function(){var t=$.getValByNames(["id","name"],$("#modal-team"));return t.name?($.http.post(t.id?"/team/update/"+t.id:"/team/create",t,{success:function(){$.message.tip("操作成功",function(){window.location.reload()})},error:function(t,e,i){$.message.warn(i)}}),!1):($.message.warn("请输入团队名称"),!1)}))}),$(function(){"setting/user"==$("body").data("location")&&($('[name="status"]').switch().bind("switch-on",function(){var t=$(this).closest("tr").data("id"),e=$(this);$.http.post("/setting/updateUser/"+t,{status:"1"},{error:function(t,i,a){$.message.warn(a),e.switch("rollback")},success:function(){e.closest("tr").removeClass("forbidden")}})}).bind("switch-off",function(){var t=$(this).closest("tr").data("id"),e=$(this);$.http.post("/setting/updateUser/"+t,{status:"0"},{error:function(t,i,a){$.message.warn(a),e.switch("rollback")},success:function(){e.closest("tr").addClass("forbidden")}})}),$('[handle="resetPassword"]').click(function(){var t=$(this).closest("tr").data("id"),e=$(this).closest("tr").data("name"),i=parseInt(1e6*Math.random());$.message.confirm("确认重置该用户的密码?",{content:e,yes:function(){$.http.post("/setting/updateUser/"+t,{password:i},{error:function(t,e,i){$.message.warn(i)},success:function(){$.message.notify("重置成功, "+e+'的新密码是 "'+i+'"')}})}})}),$('[handle="create"]').click(function(){$("#modal-user").modal("show"),$('#modal-user [name="name"]').val(""),$('#modal-user [name="password"]').val(parseInt(1e6*Math.random()))}),$('#modal-user [handle="submit"]').click(function(){var t=$.getValByNames(["name","password"],$("#modal-user"));t.name?/^[a-z]+[0-9]*$/.test(t.name)?$.http.post("/setting/createUser",t,{success:function(){$("#modal-user").modal("hide"),$.message.tip("创建成功",function(){window.location.reload()})},error:function(t,e,i){$.message.warn(i)}}):$.message.warn("请输入正确的用户名(字母或字母+数字)"):$.message.warn("用户名不能为空")}))}),$(function(){"setting/account"==$("body").data("location")&&($("#form-reset-password").validator({rules:{currentPassword:"required",newPassword:"required|minLength:6",repeatPassword:"required|minLength:6"}}).submit(function(){if(!$(this).data("instance.validator").isValid())return!1;var t=$.getValByNames(["currentPassword","newPassword","repeatPassword"],$("#form-reset-password"));if(t.newPassword!=t.repeatPassword)return $.message.warn("两次输入的新密码不一致"),!1;var e=$('button[type="submit"]',$(this)).loading("start");return $.http.post("/setting/resetPassword",{currentPassword:t.currentPassword,newPassword:t.newPassword},{progress:!0,error:function(t,e,i){$.message.warn(i)},complete:function(){e.loading("done")}}),!1}),$("#form-reset-password").find("input").val(""))}),$(function(){if("setting/teamUser"==$("body").data("location")){var t=$("#modal-teamUser");$('[handle="create"]').click(function(){t.find('[name="id"]').val(""),t.find('[name="name"]').val("").prop("disabled",!1),t.find('[name="role"][value="team.user.write"]').prop("checked",!0),t.find(".modal-title").text("添加团队成员"),t.modal("show")}),$('[handle="update"]').click(function(){var e=$(this).closest("tr").data("model");t.find('[name="id"]').val(e.id),t.find('[name="name"]').val(e.name).prop("disabled",!0),t.find('[name="role"][value="'+e.role+'"]').prop("checked",!0),t.find(".modal-title").text("编辑团队成员"),t.modal("show")}),$('[handle="delete"]').click(function(){var t=$(this).closest("tr").data("model");$.message.confirm("确认将此用户踢出团队?",{content:t.name,yes:function(){$.http.post("/team/deleteUser/"+t.id,{},{success:function(){$.message.tip("删除成功",function(){window.location.reload()})},error:function(t,e,i){$.message.warn(i)}})}})}),$('[handle="submit"]',t).click(function(){var e=$.getValByNames(["id","name","role"],t);if(!e.name)return $.message.warn("请输入团队名称"),!1;if(!e.id){var i=e.name.replace(/\r/g,"").split("\n");e.name=[];for(var a=0;a<i.length;a++)if(i[a]){var s=i[a].trim();if(_.indexOf(e.name,s)>=0)return $.message.warn("第"+(a+1)+"行重复输入"),!1;if(!/^[a-z]+[0-9]*$/.test(s))return $.message.warn("第"+(a+1)+"行不是有效的用户名"),!1;e.name.push(s)}}return $.http.post(e.id?"/team/updateUser/"+e.id:"/team/createUser",e,{success:function(){$.message.tip("保存成功",function(){window.location.reload()})},error:function(t,e,i){$.message.warn(i)}}),!1})}});