$(function(){({default:{id:"",name:"",sort:100,groupId:""},validator:{},initialized:!1,$modal:$("#modal-createDashboard"),$form:$("#modal-createDashboard form"),init:function(){return this.initialized?this:(this._render()._listen(),this.initialized=!0,this)},_render:function(){return app.dashboard?($(".chart-container").removeClass("hide"),app.charts.length||$('[handle="createChart"]').tooltip("show")):($(".no-dashboard-tips").removeClass("hide"),$('[handle="createChart"]').hide()),this},_listen:function(){var a=this;return $('[handle="createDashboard"]').click(function(){a._create()}),$('[handle="shareDashboard"]').click(function(){$.makeShareUrl("dashboard",app.dashboard.id)}),$('[handle="submit"]',this.$modal).click(function(){a.$form.trigger("submit")}),this.$modal.on("submit","form",function(){return a._submit(),!1}),this},_create:function(){return this.validator=this.$form.validator({rules:{name:"required|maxLength:50",sort:"required|int"}}).data("instance.validator"),this.$modal.modal("show"),this},_submit:function(){if(!this.validator.isValid())return!1;var a=this;$.http.post("/dashboard/create",$.getValByNames(["name","groupId","sort"],this.$form),{success:function(t){a.$modal.modal("hide"),$.message.tip("保存成功",function(){window.location.reload()})},error:function(a,t,e){$.message.warn(e)}})}}).init()}),$(function(){({$modalOfCreate:$("#modal-createChart"),$step:$("#modal-createChart .unit-step"),$btnCreateChart2:$('#modal-createChart [handle="createChart2"]'),$btnCreateChart3:$('#modal-createChart [handle="createChart3"]'),$btnSubmit:$('#modal-createChart [handle="submit"]'),model:{},default:{id:"",name:"",format:"",index:{id:"",name:"",mapping:{}},builder:{},dashboardId:""},esChart:{},esChartBuilder:{},formats:[{key:"line",name:"折线图"},{key:"bar",name:"柱状图"},{key:"pie",name:"饼状图"},{key:"panel",name:"仪表盘"},{key:"radar",name:"雷达图"},{key:"table",name:"表格"}],initialized:!1,init:function(){return this.initialized?this:(this._listen(),this.initialized=!0,this)},_listen:function(){var a=this;$("#dashboard").on("click",'[handle="createChart"]',function(){$cell=$(this).closest(".dashboard-cell"),a._create()}),this.$modalOfCreate.on("click",".chart-format-item .format-icon",function(){$(this).siblings("label").children("input:radio").prop("checked",!0).trigger("change")}),this.$modalOfCreate.on("click",".chart-index-list li",function(){$("input:radio",$(this)).prop("checked",!0).trigger("change")}),this.$btnCreateChart2.click(function(){a.model.format&&a._create2()}),this.$btnCreateChart3.click(function(){a.model.index.id&&a._create3()}),this.$modalOfCreate.on("click",'[handle="runChart"]',function(){a._run()}),this.$btnSubmit.click(function(){a._createSubmit($cell)})},_create:function(){return this.model=$.extend(!0,{},this.default),this.$step.children("li").removeClass("done").removeClass("active"),this.$modalOfCreate.find(".modal-footer .btn-primary").hide().prop("disabled",!0),this.$modalOfCreate.modal("show"),this._create1()},_create1:function(){this.$step.children(":eq(0)").addClass("active"),this.$btnCreateChart2.show();var a=$.renderFormTpl("chart","createChart-1",{formats:this.formats});$(".modal-body",this.$modalOfCreate).html(a);var t=this;return $('input[name="format"]',this.$modalOfCreate).change(function(){t.model.format=$(this).val(),t.$btnCreateChart2.prop("disabled",!t.model.format)}).first().prop("checked",!0).trigger("change"),this},_create2:function(){this.$step.children(":eq(0)").removeClass("active").addClass("done"),this.$step.children(":eq(1)").addClass("active"),this.$btnCreateChart2.hide(),this.$btnCreateChart3.show();var a=$.renderFormTpl("chart","createChart-2",{indices:app.indices});$(".modal-body",this.$modalOfCreate).html(a);var t=this;$('input[name="index"]',this.$modalOfCreate).change(function(){t.model.index=_.findWhere(app.indices,{id:$(this).val()}),t.$btnCreateChart3.prop("disabled",!t.model.index.id)}).first().prop("checked",!0).trigger("change")},_create3:function(){this.$step.children(":eq(1)").removeClass("active").addClass("done"),this.$step.children(":eq(2)").addClass("active"),this.$btnCreateChart3.hide(),this.$btnSubmit.show().prop("disabled",!1);var a=$.renderFormTpl("chart","createChart-3",{builder:this.model.builder});$(".modal-body",this.$modalOfCreate).html(a),this.esChartBuilder=$('input[name="builder"]',this.$modalOfCreate).esChartBuilder({format:this.model.format,mapping:this.model.index.mapping}).data("instance.esChartBuilder");var t=this;this.esChart=$(".chart-body",this.$modalOfCreate).esChart({format:this.model.format,loadingStart:function(){$('[handle="runChart"]',t.$modalOfCreate).prop("disabled",!0).children(".iconfont").show()},loadingDone:function(){$('[handle="runChart"]',t.$modalOfCreate).prop("disabled",!1).children(".iconfont").hide()}}).data("instance.esChart")},_createSubmit:function(a){if(!this.esChartBuilder.validate())return this;if(this.model.builder=JSON.stringify(this.esChartBuilder.getValue()),!$('.chart-name input[name="name"]').val())return $.message.warn("请输入图表名称"),this;this.model.name=$('.chart-name input[name="name"]').val(),this.model.dashboardId=app.dashboard.id,this.model.indexId=this.model.index.id;var t=this;$.http.post("/chart/create",this.model,{success:function(e){$.message.tip("图表创建成功",function(){t.$modalOfCreate.modal("hide"),app.charts.push(e.detail),a.data("content",e.detail.id).trigger("render")})},error:function(a,t,e){$.message.warn(e)}})},_run:function(){if(!this.esChartBuilder.validate())return this;var a=this.esChartBuilder.getValue(),t="/es/search/";return t+=this.model.format,t+="?url="+app.cluster.url,t+="&index="+this.model.index.name,t+="&builder="+JSON.stringify(a),this.esChart.setUrl(t).refresh(!0),this}}).init()}),$(function(){({$dashboard:$("#dashboard"),templateOfItem:$("#template-chart-item").html(),templateOfEmpty:$("#template-chart-empty").html(),initialized:!1,init:function(){return this.initialized?this:(this._listen()._render(),this.initialized=!0,this)},_render:function(){var a=this;return this.$dashboard.dashboardGrid({dragger:".chart-head",rightResizer:".chart-resize-right",content:a.templateOfItem,empty:a.templateOfEmpty}),$('#modal-copyChart [name="groupId"]').select({options:app.groups}),$('#modal-copyChart [name="dashboardId"]').select(),this},_listen:function(){var a=this;return this.$dashboard.bind("change.dashboardGrid",function(){a._saveGrid()}),this.$dashboard.on("resized.dashboardGrid",".dashboard-cell",function(){a._resize($(this).children(".chart-item"))}),this.$dashboard.on("render",".dashboard-cell",function(){a.$dashboard.data("instance.dashboardGrid").renderCell($(this)),a.$dashboard.trigger("change.dashboardGrid")}),this.$dashboard.on("render.dashboardGrid",".dashboard-cell",function(){a._drawEsChart($(this).children())}),this.$dashboard.on("click",'[handle="refresh"]',function(){$(this).children(".icon-refresh").hasClass("hide")||$(this).closest(".chart-item").children(".chart-body").data("instance.esChart").refresh()}),this.$dashboard.on("click",'[handle="update"]',function(){var t=a._getChartModelById($(this).closest(".chart-item").data("id"));a._update(t)}),$("#modal-updateChart").bind("hidden.bs.modal",function(){$(this).find('[name="builder"]').esChartBuilder("destroy"),$(this).find(".chart-body").esChart("destroy")}),$("#modal-updateChart").bind("shown.bs.modal",function(){var t=a._getChartModelById($('#modal-updateChart [name="id"]').val());$("#modal-updateChart .chart-body").esChart({url:a._getEsChartUrl(t),format:t.format,loadingStart:function(){$('#modal-updateChart [handle="runChart"]').prop("disabled",!0).children(".iconfont").show()},loadingDone:function(){$('#modal-updateChart [handle="runChart"]').prop("disabled",!1).children(".iconfont").hide()}})}),$('#modal-updateChart [handle="submit"]').click(function(){a._submitUpdate()}),$('#modal-updateChart [handle="runChart"]').click(function(){var t=a._getChartModelById($('#modal-updateChart [name="id"]').val());a._runUpdate(t)}),this.$dashboard.on("click",'[handle="copy"]',function(){a._copy($(this).closest(".chart-item").data("id"))}),this.$dashboard.on("click",'[handle="move"]',function(){a._move($(this).closest(".chart-item").data("id"))}),$('#modal-copyChart [name="groupId"]').change(function(){var a=$(this).val();a?$.http.get("/option/dashboard/"+a,{},{async:!1,success:function(a){$('#modal-copyChart [name="dashboardId"]').select("updateOptions",a)}}):$('#modal-copyChart [name="dashboardId"]').select("updateOptions",[])}),$("#modal-copyChart form").validator({rules:{groupId:"required",dashboardId:"required"}}),$('#modal-copyChart [handle="submitCopy"]').click(function(){a._submitCopy()}),$('#modal-copyChart [handle="submitMove"]').click(function(){a._submitMove()}),this.$dashboard.on("click",'[handle="share"]',function(){var a=$(this).closest(".chart-item").data("id");$.makeShareUrl("chart",a)}),this.$dashboard.on("click",'[handle="delete"]',function(){var t=$(this).closest(".chart-item"),e=t.data("id"),r=_.findWhere(app.charts,{id:e+""});$.message.confirm("您确定删除该图表吗",{content:r.name,yes:function(){$.http.post("/chart/delete/"+r.id,{},{success:function(){$.message.tip("删除成功",function(){a.$dashboard.data("instance.dashboardGrid").removeCell(t.parent())})}})}})}),$(".app-right").bind("resize",function(){$(".chart-item",a.$dashboard).each(function(){a._resize($(this))})}),this},_resize:function(a){if(a.length){var t=a.children(".chart-body").data("instance.esChart");t&&t.resize()}},_saveGrid:_.debounce(function(){var a=this.$dashboard.data("instance.dashboardGrid").toString();$.http.post("/dashboard/saveGrid/"+app.dashboard.id,{grid:a},{error:function(){$.message.warn("保存布局失败")}})},300),_drawEsChart:function(a){var t=this._getChartModelById(a.data("id"));return a.find(".chart-title").text(t.name),a.find(".chart-body").esChart({url:this._getEsChartUrl(t),format:t.format,loadingStart:function(){a.find('[handle="refresh"] .icon-refresh').addClass("hide"),a.find('[handle="refresh"] .icon-loading').removeClass("hide")},loadingDone:function(){a.find('[handle="refresh"] .icon-refresh').removeClass("hide"),a.find('[handle="refresh"] .icon-loading').addClass("hide")},$scopeRange:$(".chart-datetime .datetime-range",a)}),this},_reDrawEsChart:function(a,t,e){var r=a.data("id"),i=_.findIndex(app.charts,function(a){return a.id==r});return app.charts[i].builder=t,app.charts[i].name=e,a.find(".chart-body").esChart("destroy"),a.find(".chart-title").text(e),this._drawEsChart(a)},_update:function(a){var t=_.findWhere(app.indices,{id:a.indexId+""});$('#modal-updateChart [name="id"]').val(a.id),$('#modal-updateChart [name="name"]').val(a.name),$('#modal-updateChart [name="builder"]').val(a.builder).esChartBuilder({format:a.format,mapping:t.mapping}),$("#modal-updateChart").modal("show")},_submitUpdate:function(){var a=$('#modal-updateChart [name="builder"]').data("instance.esChartBuilder");if(!a.validate())return!1;var t=JSON.stringify(a.getValue()),e=$('#modal-updateChart [name="id"]').val(),r=$('#modal-updateChart [name="name"]').val();if(!r)return $.message.warn("图表名称不能为空"),this;var i=this;$.http.post("/chart/update/"+e,{builder:t,name:r},{success:function(){$.message.tip("保存成功",function(){$("#modal-updateChart").modal("hide"),i._reDrawEsChart($('.chart-item[data-id="'+e+'"]'),t,r)})},error:function(a,t,e){$.message.warn(e)}})},_runUpdate:function(a){var t=$('#modal-updateChart [name="builder"]').data("instance.esChartBuilder");if(!t.validate())return this;a.builder=JSON.stringify(t.getValue());var e=this._getEsChartUrl(a);return $("#modal-updateChart .chart-body").data("instance.esChart").setUrl(e).refresh(!0),this},_copy:function(a){$("#modal-copyChart").find(".modal-title").text("复制图表"),$('#modal-copyChart [handle="submitCopy"]').removeClass("hide"),$('#modal-copyChart [handle="submitMove"]').addClass("hide"),$('#modal-copyChart [name="id"]').val(a),$("#modal-copyChart").modal("show")},_submitCopy:function(){var a=$("#modal-copyChart form").trigger("submit"),t=$.getValByNames(["id","groupId","dashboardId"],a);a.data("instance.validator").isValid()&&$.http.post("/chart/copy/"+t.id,{dashboardId:t.dashboardId},{success:function(){$.message.tip("图表复制成功, 正在跳转到目标统计面板",function(){window.location.href="/dashboard/detail/"+t.groupId+"/"+t.dashboardId})},error:function(a,t,e){$.message.warn(e)}})},_move:function(a){$("#modal-copyChart").find(".modal-title").text("移动图表"),$('#modal-copyChart [handle="submitCopy"]').addClass("hide"),$('#modal-copyChart [handle="submitMove"]').removeClass("hide"),$('#modal-copyChart [name="id"]').val(a),$("#modal-copyChart").modal("show")},_submitMove:function(){var a=this;$form=$("#modal-copyChart form").trigger("submit"),formData=$.getValByNames(["id","groupId","dashboardId"],$form),$chart=$('.chart-item[data-id="'+formData.id+'"]',a.$dashboard),$form.data("instance.validator").isValid()&&$.http.post("/chart/move/"+formData.id,{dashboardId:formData.dashboardId},{success:function(){a.$dashboard.data("instance.dashboardGrid").removeCell($chart.parent()),$.message.tip("图表移动成功, 正在跳转到目标统计面板",function(){window.location.href="/dashboard/detail/"+formData.groupId+"/"+formData.dashboardId})},error:function(a,t,e){$.message.warn(e)}})},_getChartModelById:function(a){return _.findWhere(app.charts,{id:a+""})},_getEsChartUrl:function(a){var t=_.findWhere(app.indices,{id:a.indexId+""});return"/es/search/"+a.format+"?url="+app.cluster.url+"&index="+t.name+"&builder="+a.builder}}).init(),{$el:$("#auto-refresh"),intervalId:null,initialized:!1,init:function(){if(this.initialized)return this;this._listen();var a=this._fromLocalStorage()?this._fromLocalStorage():0;return $('.dropdown-menu li[value="'+a+'"]',this.$el).trigger("click"),this.initialized=!0,this},_listen:function(){var a=this;$(".dropdown-menu li",this.$el).click(function(){$(this).hasClass("active")||(a._pick($(this).attr("value")),$(this).addClass("active").siblings().removeClass("active"),$("button .text",a.$el).text($(this).find("a").text()))})},_pick:function(a){this.intervalId&&window.clearInterval(this.intervalId),this.intervalId=window.setInterval(function(){$('.chart-item [handle="refresh"]').trigger("click")},parseInt(a)?1e3*parseInt(a):1e11),this._toLocalStorage(a)},_toLocalStorage:function(a){return window.localStorage.setItem("auto-refresh",a),this},_fromLocalStorage:function(){return window.localStorage.getItem("auto-refresh")}}.init()});