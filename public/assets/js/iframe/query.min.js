$(function(){({list:[],fields:[],page:1,pageSize:50,nextPage:!0,total:0,scopeField:"",displayFieldsPicker:null,templateOfHead:"listHead",templateOfBody:"listBody",param:{url:"",index:"",builder:""},initialized:!1,$table:$("table"),$displayFieldsPicker:$('[handle="pickDisplayFields"]'),$pageLoading:$(".page-loading"),$total:$(".query-total"),init:function(){return this.initialized?this:(this.param.url=$.getParam("url"),this.param.index=$.getParam("index"),this.param.builder=JSON.parse($.getParam("builder")),this.scopeField=this._getScopeField(),this._getPageDataThenRender(),this._listen(),this.initialized=!0,this)},_listen:function(){var e=this;return $(window).scroll(_.debounce(function(){$(this).scrollTop()+$(this).height()-e.$pageLoading.offset().top>0&&e._getPageDataThenRender()},300)),this.$displayFieldsPicker.bind("displayFieldsPicker.change",function(){e.fields=e.displayFieldsPicker.getChecked(),e._renderHead(),e._renderBody()}),this.$table.on("click",'[handle="showSource"]',function(){var t=$(this).closest("tr").addClass("source-top"),i=t.data("index"),s=e.list[i],a="{\n";for(var r in s)0!=r.indexOf("_")&&(a+='    "<span style="color: #0ac">'+r+'</span>":"'+s[r]+'"\n');a+="}",t.after('<tr class="source"><td colspan="100"><pre>'+a+"</pre></td></tr>"),$(this).addClass("hide"),$(this).siblings('[handle="hideSource"]').removeClass("hide")}),this.$table.on("click",'[handle="hideSource"]',function(){$(this).closest("tr").removeClass("source-top").next(".source:first").remove(),$(this).addClass("hide"),$(this).siblings('[handle="showSource"]').removeClass("hide")}),this.$table.on("click",'[handle="download"]',function(){var t=$(this).closest("tr").data("index"),i=e.list[t].__download__;if(!i)return $.message.warn("无法导出, 该日志没有@timestamp或fromhost或path字段"),!1;window.open("/es/search/text?"+i)}),this},_getPageDataThenRender:function(){if(!this.nextPage)return this;var e=this,t=this.page++,i="/es/search/query"+window.location.search+"&page="+t+"&pageSize="+this.pageSize;return $.http.get(i,{},{progress:!0,success:function(i){i.list=e._formatAfterGetList(i.list),e.list=e.list.concat(i.list),1==t&&(e._renderFieldsPicker(i.list.length?_.keys(i.list[0]):[]),e.fields=e.displayFieldsPicker.getChecked(),e._renderHead()),e._appendBody(i.list,(t-1)*e.pageSize),e.nextPage=!!i.list.length,e.$total.text(i.total),e.nextPage||e.$pageLoading.text("数据已全部加载")},error:function(e,t,i){$.message.warn(i)}}),this},_renderHead:function(){var e=$.render(this.templateOfHead,{fields:this.fields});return $("thead",this.$table).empty().html(e),$('thead [data-toggle="tooltip"]',this.$table).tooltip(),this},_renderBody:function(){var e=$.render(this.templateOfBody,{list:this.list,fields:this.fields,from:0});return $("tbody",this.$table).html(e),this},_appendBody:function(e,t){var i=$.render(this.templateOfBody,{list:e,fields:this.fields,from:t});return $("tbody",this.$table).append(i),this},_renderFieldsPicker:function(e){return this.$displayFieldsPicker.displayFieldsPicker({fields:e.sort(),localStorageKey:this.param.url+"/"+this.param.index}),this.displayFieldsPicker=this.$displayFieldsPicker.data("instance.displayFieldsPicker"),this},_getScopeField:function(){return this.param.builder.scope.field},_formatAfterGetList:function(e){for(var t=0;t<e.length;t++){var i=e[t];if(i["@timestamp"]&&i.fromhost&&i.path){var s={"@timestamp":moment(i["@timestamp"]).valueOf(),fromhost:i.fromhost,path:i.path};i.__download__="url="+this.param.url+"&index="+this.param.index+"&builder="+JSON.stringify(s)}else i.__download__="";i[this.scopeField]&&(i[this.scopeField]=moment(i[this.scopeField]).format("YYYY-MM-DD HH:mm:ss"))}return e}}).init()});